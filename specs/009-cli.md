# 009 - CLI

## Overview

**Purpose:** Define the command-line interface, global flags, command semantics, and output conventions.

**Scope:** Command structure, argument parsing, ID resolution, exit codes, output modes, onboarding.

**Out of scope:** Phase-specific behavior (covered in 001-006), agent execution, item storage.

### Where This Applies

- All user interactions with wreckit
- Primary component: `src/index.ts`

---

## Security Model: Safe Defaults

### Core Principle

The CLI should be safe to run by default. Destructive operations require explicit flags. Dry-run mode must have no side effects.

### Guardrails Required

| Guardrail            | Purpose                                  |
| -------------------- | ---------------------------------------- |
| **PR Mode Default**  | Direct merge requires explicit config    |
| **Dry-Run Fidelity** | `--dry-run` never modifies state         |
| **Force Flags**      | Overwriting artifacts requires `--force` |
| **Onboarding Gate**  | First run guides initialization          |

---

## Command Structure

```
wreckit [command] [args] [flags]
```

### Core Commands

| Command             | Description                                 |
| ------------------- | ------------------------------------------- |
| `wreckit`           | Run all incomplete items through phases     |
| `wreckit next`      | Run next incomplete item                    |
| `wreckit run <id>`  | Run single item through all phases          |
| `wreckit ideas`     | Ingest ideas from stdin, file, or interview |
| `wreckit status`    | List all items with state                   |
| `wreckit list`      | List items with optional filtering          |
| `wreckit show <id>` | Show item details                           |

### Phase Commands

| Command                  | Transition             |
| ------------------------ | ---------------------- |
| `wreckit research <id>`  | idea → researched      |
| `wreckit plan <id>`      | researched → planned   |
| `wreckit implement <id>` | planned → implementing |
| `wreckit pr <id>`        | implementing → in_pr   |
| `wreckit complete <id>`  | in_pr → done           |

### Utility Commands

| Command            | Description                              |
| ------------------ | ---------------------------------------- |
| `wreckit init`     | Initialize `.wreckit/` in repository     |
| `wreckit doctor`   | Validate items and optionally fix issues |
| `wreckit sdk-info` | Display SDK configuration info           |

---

## Global Flags

| Flag           | Description                          |
| -------------- | ------------------------------------ |
| `--verbose`    | Enable verbose output                |
| `--quiet`      | Suppress non-essential output        |
| `--debug`      | Output structured JSON logs (ndjson) |
| `--no-tui`     | Disable terminal UI (CI mode)        |
| `--tui-debug`  | Enable TUI debug mode                |
| `--dry-run`    | Preview without making changes       |
| `--mock-agent` | Simulate agent responses             |
| `--cwd <path>` | Override working directory           |

### Command-Specific Flags

| Command                                      | Flag                | Description                     |
| -------------------------------------------- | ------------------- | ------------------------------- |
| `ideas`                                      | `-f, --file <path>` | Read from file instead of stdin |
| `status`, `list`, `show`                     | `--json`            | Output as JSON                  |
| `list`                                       | `--state <state>`   | Filter by state                 |
| `research`, `plan`, `implement`, `pr`, `run` | `--force`           | Regenerate artifacts            |
| `doctor`                                     | `--fix`             | Auto-fix recoverable issues     |
| `init`                                       | `--force`           | Overwrite existing `.wreckit/`  |

---

## ID Resolution

Item IDs can be specified in multiple formats:

| Format         | Example             | Matches                                 |
| -------------- | ------------------- | --------------------------------------- |
| Full ID        | `001-add-dark-mode` | Exact match                             |
| Numeric prefix | `1` or `001`        | First item starting with `001-`         |
| Slug suffix    | `add-dark-mode`     | First item ending with `-add-dark-mode` |

### Resolution Logic

1. Try exact match against item IDs
2. Try numeric prefix match (zero-padded)
3. Try slug suffix match
4. Return error if no match or ambiguous

---

## Onboarding

First-time usage triggers onboarding:

1. Check if `.wreckit/` exists
2. If not, prompt for initialization
3. If non-interactive (piped/CI), exit with error
4. Guide user through `wreckit init`

### Onboarding Triggers

- `wreckit` (default command)
- `wreckit next`

### Bypass

Commands that don't require initialization work without `.wreckit/`:

- `wreckit init`
- `wreckit --help`
- `wreckit --version`

---

## Output Modes

### Default (Human-Readable)

Progress messages, status tables, and summaries formatted for terminal.

### JSON Output

For `status`, `list`, `show` commands with `--json` flag:

```json
{
  "items": [
    {
      "id": "001-add-dark-mode",
      "state": "planned",
      "title": "Add dark mode toggle"
    }
  ]
}
```

### Debug Output (NDJSON)

With `--debug`, all logs are newline-delimited JSON:

```json
{"level":"info","message":"Starting phase: research","timestamp":"..."}
{"level":"debug","message":"Loading config","timestamp":"..."}
```

---

## TUI Mode

By default, wreckit displays a terminal UI for progress visualization.

### When TUI is Active

- Running `wreckit` or `wreckit next` in an interactive terminal
- Not disabled via `--no-tui`

### When TUI is Disabled

- `--no-tui` flag set
- Non-interactive terminal (CI, piped)
- Running phase commands directly (`wreckit research <id>`)

### TUI Features

- Real-time agent output streaming
- Phase progress indicators
- Error display

---

## Exit Codes

| Code | Meaning                     |
| ---- | --------------------------- |
| 0    | Success                     |
| 1    | Error (any failure)         |
| 130  | Interrupted (SIGINT/Ctrl-C) |

### Error Mapping

| Error Type          | Exit Code |
| ------------------- | --------- |
| `RepoNotFoundError` | 1         |
| `ConfigError`       | 1         |
| `ItemNotFoundError` | 1         |
| Agent failure       | 1         |
| Validation failure  | 1         |
| SIGINT              | 130       |
| SIGTERM             | 130       |

---

## Interrupt Handling

On SIGINT/SIGTERM:

1. Log "Interrupted"
2. Terminate all running agents (SIGTERM, then SIGKILL after 5s)
3. Exit with code 130

Partial state from interrupted runs is preserved for resumption.

---

## Dry-Run Mode

With `--dry-run`:

- Log what would happen
- Do not run agents
- Do not modify files
- Do not create commits or PRs
- Return success

Example output:

```
[dry-run] Would run SDK agent
[dry-run] Working directory: /path/to/.wreckit/items/001-feature
[dry-run] Prompt length: 3456 characters
```

---

## Error Handling

| Error Condition           | Behavior                                     |
| ------------------------- | -------------------------------------------- |
| Repository not found      | Exit 1 with "Could not find repository root" |
| Item not found            | Exit 1 with "Item not found: <id>"           |
| Config invalid            | Exit 1 with validation error                 |
| Phase prerequisite failed | Exit 1 with state mismatch error             |
| Agent failure             | Exit 1, error stored on item                 |

### Error Display

Errors are logged via the logger:

- `--quiet`: Only errors shown
- Default: Errors and warnings
- `--verbose`: All logs including debug

---

## Batch Orchestration

### `wreckit` (Run All)

1. Scan all items
2. Filter to incomplete (not `done` or `in_pr`)
3. Process each through remaining phases
4. Report completed, failed, remaining counts
5. Exit 1 if any failed

### `wreckit next`

1. Scan all items
2. Find first incomplete item
3. Process through remaining phases
4. Report success/failure
5. Exit 0 if no items or success, 1 if failed

---

## Implementation Status

| Feature                    | Status         | Notes                                                       |
| -------------------------- | -------------- | ----------------------------------------------------------- |
| **Core commands**          | ✅ Implemented | `wreckit`, `next`, `run`, `ideas`, `status`, `list`, `show` |
| **Phase commands**         | ✅ Implemented | `research`, `plan`, `implement`, `pr`, `complete`           |
| **Utility commands**       | ✅ Implemented | `init`, `doctor`, `sdk-info`                                |
| **Global flags**           | ✅ Implemented | All flags in spec                                           |
| **Command-specific flags** | ✅ Implemented | `--file`, `--json`, `--state`, `--force`, `--fix`           |
| **ID resolution**          | ✅ Implemented | Full ID, numeric prefix, slug suffix                        |
| **Onboarding**             | ✅ Implemented | See `src/onboarding.ts`                                     |
| **JSON output**            | ✅ Implemented | `--json` flag for status/list/show                          |
| **Debug output (NDJSON)**  | ✅ Implemented | `--debug` flag                                              |
| **TUI mode**               | ✅ Implemented | See `src/tui/`                                              |
| **Dry-run mode**           | ✅ Implemented | `--dry-run` flag                                            |
| **Interrupt handling**     | ✅ Implemented | SIGINT/SIGTERM → exit 130                                   |
| **Exit codes**             | ✅ Implemented | 0, 1, 130                                                   |
| **Parallel execution**     | ✅ Implemented | `--parallel <n>` flag                                       |

---

## Known Gaps

### Gap 1: No Parallel Execution ✅ FIXED

~~Batch commands process items sequentially. No built-in parallelism.~~

**Status:** Fixed - `--parallel <n>` flag implemented. See `orchestrateAll` in `src/commands/orchestrator.ts`.

### Gap 2: No Progress Persistence

Batch progress is not persisted. Ctrl-C loses position in queue.

**Impact:** Must rescan and filter on resume.

**Status:** Open - No progress persistence implemented.

### Gap 3: Ambiguous ID Resolution

Slug suffix matching can be ambiguous if multiple items share suffix.

**Impact:** Wrong item selected.

**Status:** Open - Still returns first match on ambiguous suffix.

---

## See Also

- [007-item-store.md](./007-item-store.md) — Item data model
- [010-doctor.md](./010-doctor.md) — State validation and repair
