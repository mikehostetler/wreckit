# API Overview

Cybernetic's Edge Gateway is a Phoenix HTTP API that fronts the VSM systems.

## Authentication

Production requests to `/v1/*` require one of:

- `x-api-key: <key>` (recommended): set `CYBERNETIC_SYSTEM_API_KEY` and send it as `x-api-key`
- `Authorization: Bearer <token>`: validated by `Cybernetic.Security.AuthManager` (dual-mode: session + JWT/OIDC)

Dev/test allows unauthenticated requests (a default tenant is assigned).

### Auth Contract

The authentication system supports two token types:

#### 1. Session Tokens (Stateful)

Generated by `POST /v1/auth/login` with username/password:

```json
{"username": "...", "password": "..."}
```

Response includes:
- `token`: Session JWT stored in ETS (TTL: 1 hour by default)
- `refresh_token`: For obtaining new tokens without re-auth
- `expires_in`: Seconds until expiry

Session tokens are validated against `:auth_sessions` ETS table. Expiration is enforced; expired tokens are deleted on access.

**Important**: Session tokens (HS256) do not survive server restarts. After restart, users must re-authenticate to get a new session token.

#### 2. External JWT/OIDC Tokens (Stateless)

If a Bearer token is not found in the session store, it falls back to `Cybernetic.Security.JWT.verify_external/1`:

- **RS256 only**: Verified using JWKS from `OIDC_JWKS_URL` or discovered via `OIDC_ISSUER`
- **HS256 rejected**: Returns `:session_expired` error (session tokens must be in ETS)

This design prevents session tokens from becoming stateless after restart, ensuring proper session lifecycle management.

Validations performed:
- Signature (strict algorithm match)
- `exp` (expiration with configurable clock skew, default 60s)
- `nbf` (not-before with clock skew)
- `iss` (issuer, if `OIDC_ISSUER` configured)
- `aud` (audience, if `OIDC_AUDIENCE` configured)

#### Claims â†’ Auth Context Mapping

The following JWT claims are mapped to the internal auth context:

| JWT Claim | Auth Context Field | Notes |
|-----------|-------------------|-------|
| `sub` | `user_id` | Required |
| `tenant_id` | `metadata.tenant_id` | Custom claim for multi-tenancy |
| `roles` | `roles` | Array of role strings (e.g., `["admin", "operator"]`) |
| `permissions` | N/A | Derived from roles via RBAC |

If `tenant_id` is not present in claims, it defaults to `user_id` (single-tenant mode).

#### Supported Roles

| Role | Permissions |
|------|-------------|
| `admin` | All operations |
| `operator` | read, write, execute, monitor |
| `viewer` | read, monitor |
| `agent` | read, write, execute_limited |
| `system` | All operations + internal APIs |

### Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `JWT_SECRET` | Prod: Yes | Secret for HS256 signing/verification (min 32 chars) |
| `OIDC_ISSUER` | No | OIDC issuer URL for RS256 (enables JWKS discovery) |
| `OIDC_JWKS_URL` | No | Direct JWKS URL (alternative to discovery) |
| `OIDC_AUDIENCE` | No | Expected `aud` claim value |
| `CYBERNETIC_SYSTEM_API_KEY` | Prod: Yes | API key for `x-api-key` header auth |

## Tenancy

- The gateway assigns `tenant_id` from the authenticated context.
- If `x-tenant-id` is provided, it must match the authenticated tenant (otherwise `403`).

## Endpoints

### POST `/v1/generate`

Routes a request to the S4 intelligence router.

- Body (JSON): `{"prompt": "...", "model": "default", "temperature": 0.7, "max_tokens": 2048, "stream": false}`
- Auth: required in production

### GET `/v1/events`

Server-Sent Events (SSE) stream.

- Query params:
  - `topics`: comma-separated topic patterns (e.g. `vsm.*,episode.*`)
  - `last_event_id`: optional resume token
- Auth: required in production

### POST `/telegram/webhook`

Telegram webhook receiver.

- In production, requires header `x-telegram-bot-api-secret-token` matching `TELEGRAM_WEBHOOK_SECRET`.

## Operational Notes

- Rate limiting and circuit breaking are applied to the `/v1/*` API pipeline.
- `/metrics` and `/health` are unauthenticated by default; restrict them at the network/load-balancer layer in production.

